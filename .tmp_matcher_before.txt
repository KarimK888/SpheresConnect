"use client";

import { useEffect, useMemo, useState } from "react";
import { motion, useAnimation, useMotionValue, useTransform } from "framer-motion";
import { Heart, RefreshCcw, Sparkles, X } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { useAuth } from "@/hooks/useAuth";
import { useMatch } from "@/hooks/useMatch";
import { useI18n } from "@/context/i18n";
import type { MatchSuggestion } from "@/lib/types";

const DECISION_DISTANCE = 160;
const DECISION_VELOCITY = 800;

export default function MatcherPage() {
  const { t } = useI18n();
  const { user, isAuthenticated } = useAuth();
  const { matches, loading, error, refresh, onConnect, onSkip } = useMatch(user?.userId);
  const [queue, setQueue] = useState<MatchSuggestion[]>([]);
  const [isAnimating, setIsAnimating] = useState(false);

  const controls = useAnimation();
  const x = useMotionValue(0);
  const rotate = useTransform(x, [-320, 0, 320], [-18, 0, 18]);

  useEffect(() => {
    setQueue(matches);
  }, [matches]);

  const topCandidate = queue[0];
  const nextCandidate = queue[1];

  useEffect(() => {
    controls.set({ x: 0, rotate: 0, opacity: 1 });
    x.set(0);
  }, [controls, x, topCandidate?.userId]);

  const sharedSkills = useMemo(() => {
    if (!user || !topCandidate) return [];
    return topCandidate.skills.filter((skill) => user.skills.includes(skill));
  }, [user, topCandidate]);

  const handleDecision = async (direction: "connect" | "skip") => {
    if (!topCandidate || isAnimating) return;
    setIsAnimating(true);
    const candidateId = topCandidate.userId;
    const targetX = direction === "connect" ? 520 : -520;
    const targetRotate = direction === "connect" ? 22 : -22;

    await controls.start({ x: targetX, rotate: targetRotate, opacity: 0 });

    if (direction === "connect") {
      onConnect(candidateId);
    } else {
      onSkip(candidateId);
    }

    const nextLength = queue.length - 1;
    setQueue((prev) => prev.filter((candidate) => candidate.userId !== candidateId));
    controls.set({ x: 0, rotate: 0, opacity: 1 });
    x.set(0);
    setIsAnimating(false);

    if (nextLength <= 2) {
      void refresh();
    }
  };

  const handleDragEnd = async (_event: MouseEvent | TouchEvent | PointerEvent, info: { offset: { x: number }; velocity: { x: number } }) => {
    const { offset, velocity } = info;
    if (offset.x > DECISION_DISTANCE || velocity.x > DECISION_VELOCITY) {
      await handleDecision("connect");
    } else if (offset.x < -DECISION_DISTANCE || velocity.x < -DECISION_VELOCITY) {
      await handleDecision("skip");
    } else {
      await controls.start({ x: 0, rotate: 0, opacity: 1 });
    }
  };

  const renderCandidateBadges = (candidate: MatchSuggestion) => (
    <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
      {candidate.sharedHub && <Badge variant="accent">{t("matcher_same_hub_badge")}</Badge>}
      {!candidate.sharedHub && candidate.hubName && (
        <Badge variant="outline">{t("matcher_other_hub_badge", { hub: candidate.hubName })}</Badge>
      )}
      {typeof candidate.distanceKm === "number" && (
        <span>{t("matcher_distance_label", { distance: Math.round(candidate.distanceKm) })}</span>
      )}
    </div>
  );

  const renderPreviewCard = (candidate: MatchSuggestion) => (
    <Card className="pointer-events-none mt-6 w-full max-w-md scale-95 bg-card/70 shadow-lg backdrop-blur">
      <div className="space-y-3 p-6">
        <div className="flex items-start justify-between gap-3">
          <p className="text-lg font-semibold text-white">{candidate.displayName}</p>
          {renderCandidateBadges(candidate)}
        </div>
        {candidate.bio && <p className="line-clamp-3 text-sm text-muted-foreground">{candidate.bio}</p>}
        {candidate.skills.length > 0 && (
          <div className="flex flex-wrap gap-2">
            {candidate.skills.slice(0, 4).map((skill) => (
              <Badge key={skill} variant="outline">
                {skill}
              </Badge>
            ))}
          </div>
        )}
      </div>
    </Card>
  );

  return (
    <div className="mx-auto flex w-full max-w-5xl flex-col items-center gap-8 px-6 py-10">
      <header className="flex flex-col items-center gap-3 text-center">
        <div className="inline-flex items-center gap-2 rounded-full border border-border/60 bg-border/20 px-4 py-2 text-xs uppercase tracking-[0.3em] text-muted-foreground">
          <Sparkles className="h-4 w-4 text-accent" />
          {t("matcher_title")}
        </div>
        <p className="max-w-2xl text-sm text-muted-foreground">{t("matcher_swipe_hint")}</p>
        <Badge variant="outline">{t("matcher_queue_count", { count: queue.length })}</Badge>
      </header>

      {!isAuthenticated && (
        <Card className="w-full max-w-md border-dashed border-border/60 bg-background/40 p-6 text-center text-sm text-muted-foreground">
          {t("matcher_sign_in_prompt")}
        </Card>
      )}

      {error && (
        <Card className="w-full max-w-md border-destructive/60 bg-destructive/10 p-4 text-center text-sm text-destructive">
          {error}
        </Card>
      )}

      <div className="relative flex w-full justify-center">
        {nextCandidate && renderPreviewCard(nextCandidate)}
        {topCandidate ? (
          <motion.div
            key={topCandidate.userId}
            className="absolute inset-0 flex justify-center"
            drag="x"
            dragElastic={0.4}
            dragConstraints={{ left: 0, right: 0 }}
            style={{ x, rotate }}
            animate={controls}
            whileTap={{ scale: 0.98 }}
            onDragEnd={handleDragEnd}
          >
            <Card className="w-full max-w-md overflow-hidden bg-card/90 shadow-2xl">
              <div className="space-y-6 p-6">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <h2 className="text-2xl font-semibold text-white">{topCandidate.displayName}</h2>
                    {topCandidate.bio && (
                      <p className="mt-2 text-sm text-muted-foreground">{topCandidate.bio}</p>
                    )}
                  </div>
                  {renderCandidateBadges(topCandidate)}
                </div>

                {sharedSkills.length > 0 && (
                  <div className="space-y-2">
                    <p className="text-xs uppercase tracking-[0.3em] text-muted-foreground">
                      {t("matcher_shared_skills")}
                    </p>
                    <div className="flex flex-wrap gap-2">
                      {sharedSkills.slice(0, 6).map((skill) => (
                        <Badge key={skill} variant="accent">
                          {skill}
                        </Badge>
                      ))}
                    </div>
                  </div>
                )}

                {topCandidate.skills.length > 0 && (
                  <div className="space-y-2">
                    <p className="text-xs uppercase tracking-[0.3em] text-muted-foreground">
                      {t("matcher_all_skills")}
                    </p>
                    <div className="flex flex-wrap gap-2">
                      {topCandidate.skills.slice(0, 12).map((skill) => (
                        <Badge key={skill} variant="outline">
                          {skill}
                        </Badge>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </Card>
          </motion.div>
        ) : (
          <Card className="w-full max-w-md border-border/60 bg-background/40 p-6 text-center text-sm text-muted-foreground">
            {loading ? t("generic_loading_matches") : t("matcher_no_more")}
          </Card>
        )}
      </div>

      <div className="mt-[360px] flex w-full max-w-md items-center justify-center gap-4">
        <Button
          variant="outline"
          size="icon"
          className="h-14 w-14 rounded-full border-destructive/40 text-destructive"
          onClick={() => void handleDecision("skip")}
          disabled={!topCandidate || isAnimating}
        >
          <X className="h-6 w-6" />
        </Button>
        <Button
          variant="outline"
          size="icon"
          className="h-12 w-12 rounded-full text-muted-foreground"
          onClick={() => void refresh()}
          disabled={loading || isAnimating}
        >
          <RefreshCcw className="h-5 w-5" />
        </Button>
        <Button
          variant="accent"
          size="icon"
          className="h-14 w-14 rounded-full"
          onClick={() => void handleDecision("connect")}
          disabled={!topCandidate || isAnimating}
        >
          <Heart className="h-6 w-6" />
        </Button>
      </div>
    </div>
  );
}

